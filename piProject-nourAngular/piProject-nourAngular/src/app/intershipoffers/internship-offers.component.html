<div class="container mt-5" id="internship-offers">
  <h2 class="text-center mb-4" style="color: #D32F2F; font-weight: bold;">
    Find Internship Offers
  </h2>

  <!-- Filter Section -->
  <div class="mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <input type="text" class="form-control" placeholder="Search by Title or Company"
               [(ngModel)]="searchTerm" (ngModelChange)="filterOffers()">
      </div>
      <div class="col-md-3">
        <select class="form-control" [(ngModel)]="statusFilter" (change)="filterOffers()">
          <option value="">All Status</option>
          <option value="OPEN">Open</option>
          <option value="CLOSED">Closed</option>
          <option value="ARCHIVED">Archived</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-check-label">
          <input type="checkbox" class="form-check-input" [(ngModel)]="paidFilter" (change)="filterOffers()"> Paid Offers Only
        </label>
      </div>
      <div class="col-md-3">
        <div class="input-group">
          <span class="input-group-text">Proximity (km)</span>
          <input type="number" class="form-control" [(ngModel)]="proximityRadius" (input)="onProximityChange($event)" min="1" placeholder="50">
        </div>
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12">
        <label class="form-label mb-2"><i class="bi bi-geo-alt me-2"></i>Location Filter (Click to select)</label>
        <div #mapFilter id="map-filter" class="map-container"></div>
        <small class="text-success mt-2 d-block" *ngIf="selectedLocation">Selected: {{ selectedLocation.name }} ({{ proximityRadius }} km radius)</small>
        <small class="text-danger" *ngIf="geocodeError">{{ geocodeError }}</small>
      </div>
    </div>
  </div>

  <div class="row">
    <div *ngFor="let offer of filteredOffers" class="col-md-4 mb-4">
      <div class="card shadow-sm offer-card">
        <img [src]="offer.imageUrls[0]" class="card-img-top offer-img" alt="Offer Image">
        <div class="card-body">
          <span class="badge offer-status" [ngClass]="{
            'bg-success': offer.offerStatus === 'OPEN',
            'bg-danger': offer.offerStatus === 'CLOSED',
            'bg-warning': offer.offerStatus === 'ARCHIVED'
          }">{{ offer.offerStatus }}</span>
          <h5 class="card-title mt-2" style="color: red; font-weight: bold;">{{ offer.title }}</h5>
          <p class="card-text text-muted">{{ offer.companyName }}</p>
          <p><i class="bi bi-geo-alt"></i> {{ offer.location }}</p>
          <p><strong style="color: grey;">Type:</strong> {{ offer.stageType }}</p>
          <p>
            <i class="bi" [ngClass]="offer.paid ? 'bi-cash text-success' : 'bi-cash-coin text-danger'"></i>
            {{ offer.paid ? 'Paid' : 'Unpaid' }}
          </p>

          <!-- ✅ Météo affichée ici -->
          <div *ngIf="offer.weather" class="d-flex align-items-center mt-2">
            <img [src]="'http://openweathermap.org/img/wn/' + offer.weather.weather[0].icon + '@2x.png'" alt="Weather Icon" class="me-2" style="width: 40px; height: 40px;">
            <div>
              <div><strong>{{ offer.weather.main.temp }}°C</strong> in {{ offer.weather.name }}</div>
              <div class="text-muted">{{ offer.weather.weather[0].description }}</div>
            </div>
          </div>
          <button class="btn btn-danger waves-effect" 
            style="background-color: #F28B82; border-color: #F28B82;" 
            (click)="openDetails(offer)">
            More Info
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Internship Details Modal -->
  <div *ngIf="selectedOffer" class="modal fade show d-block offer-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ selectedOffer.title }}</h5>
          <button type="button" class="btn btn-danger btn-close" 
            style="background-color: #ff4b4b; border-color: #C62828;" 
            (click)="closeDetails()">
          </button>
        </div>
        <div class="modal-body">
          <p><strong style="color: grey;">Company:</strong> {{ selectedOffer.companyName }}</p>
          <p>{{ selectedOffer.jobDescription }}</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-success waves-effect" 
            style="background-color: #F28B82; border-color: #F28B82; font-weight: bold;" 
            (click)="openApplicationForm(selectedOffer)">
            Apply
          </button>
          <button class="btn btn-danger waves-effect" 
            style="background-color: #C62828; border-color: #C62828;" 
            (click)="closeDetails()">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Application Form Modal -->
  <div *ngIf="showApplicationForm" class="modal fade show d-block application-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Apply for {{ selectedOffer?.title }}</h5>
          <button type="button" class="btn btn-danger btn-close" 
            style="background-color: #ff4b4b; border-color: #C62828;" 
            (click)="closeApplicationForm()">
          </button>
        </div>
        <div class="modal-body"><form [formGroup]="applicationForm" (ngSubmit)="submitApplication()" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label">📛 Full Name</label>
            <input type="text" class="form-control" formControlName="fullName" required>
          </div>
        
          <div class="mb-3">
            <label class="form-label">📧 Email</label>
            <input type="email" class="form-control" formControlName="email" required>
          </div>
        
          <div class="mb-3">
            <label class="form-label">📞 Phone</label>
            <input type="text" class="form-control" formControlName="phone" required>
          </div>
        
          <div class="mb-3">
            <label class="form-label">📍 City</label>
            <input type="text" class="form-control" formControlName="city" required>
          </div>
        
          <div class="mb-3">
            <label class="form-label">🎯 Career Objective</label>
            <textarea class="form-control" formControlName="careerObjective" rows="2" required></textarea>
          </div>
        
          <div class="mb-3">
            <label class="form-label">💻 Technology Profile</label>
            <textarea class="form-control" formControlName="technologyProfile" rows="2" required></textarea>
          </div>
        
          <div class="mb-3">
            <label class="form-label">🧠 Skills</label>
            <input type="text" class="form-control" formControlName="skills" placeholder="Angular, Spring, Docker" required>
          </div>
        
          <div class="mb-3">
            <label class="form-label">💼 Experiences</label>
            <textarea class="form-control" formControlName="experiences" rows="2"></textarea>
          </div>
        
          <div class="mb-3">
            <label class="form-label">🔗 LinkedIn Profile</label>
            <input type="url" class="form-control" formControlName="linkedinProfile">
          </div>
        
          <div class="mb-3">
            <label class="form-label">🌐 Portfolio / GitHub</label>
            <input type="url" class="form-control" formControlName="portfolio">
          </div>
        
          <div class="mb-3">
            <label class="form-label">📷 Upload Photo</label>
            <input type="file" (change)="onPhotoSelected($event)" accept="image/*" class="form-control">
          </div>
        
          <button type="submit" class="btn btn-danger w-100 mt-3">Submit Application</button>
        </form>
        
  <div *ngIf="hasAlreadyApplied" class="overlay">
    <div class="popup">
      <div class="popup-header">
        <h5>⚠️ Already Applied!</h5>
      </div>
      <div class="popup-body">
        <p>You have already applied for this internship.</p>
      </div>
      <div class="popup-footer">
        <button class="btn btn-danger" (click)="closeAlreadyAppliedPopup()">OK</button>
      </div>
    </div>
  </div>
</div>